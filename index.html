<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Akhir Dinas Masinis</title>
  <style>
    /* Style sama seperti sebelumnya, atau kamu bisa pakai yang sudah ada */
  </style>
</head>
<body>
  <div class="container">
    <h2>Laporan Akhir Dinas Masinis</h2>

    <form id="formData">
      <label>Nomor KA:<input type="text" id="nomorKA" required /></label>
      <label>Nama Masinis:<input type="text" id="namaMasinis" required /></label>
      <label>Nama Asisten Masinis:<input type="text" id="namaAsisten" required /></label>
      <label>Nomor Lokomotif:<input type="text" id="nomorLokomotif" required /></label>
      <label>Jam Datang (HH:MM):<input type="time" id="jamDatang" required /></label>
      <label>Terlambat (menit):<input type="number" id="terlambat" min="0" value="0" required /></label>
      <label>Tonase:<input type="number" id="tonase" min="0" required /></label>
      <label>Keterangan:<input type="text" id="keterangan" /></label>
      <button type="submit">Tambah Data</button>
      <button type="button" onclick="resetData()">Reset Semua Data</button>
    </form>

    <hr />

    <h3>Filter Data</h3>
    <label>Filter Tanggal:<input type="date" id="filterTanggal" /></label>
    <label>Filter Hari:
      <select id="filterHari">
        <option value="">--Semua Hari--</option>
        <option>Senin</option>
        <option>Selasa</option>
        <option>Rabu</option>
        <option>Kamis</option>
        <option>Jumat</option>
        <option>Sabtu</option>
        <option>Minggu</option>
      </select>
    </label>
    <button onclick="tampilkanData()">Tampilkan Filter</button>
    <button onclick="downloadCSV()">Download CSV</button>
    <button onclick="cetakPDF()">Cetak PDF</button>

    <table id="tabelLaporan">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Hari</th>
          <th>Nomor KA</th>
          <th>Nama Masinis</th>
          <th>Nama Asisten</th>
          <th>No Lokomotif</th>
          <th>Jam Datang</th>
          <th>Terlambat (mnt)</th>
          <th>Tonase</th>
          <th>Keterangan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </div>

  <script type="module">
    // Import Firebase modul dari CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBNvdB4bf4OXXqt9l7A_Xs6VzdPZp5pSTc",
      authDomain: "awal-dinas.firebaseapp.com",
      projectId: "awal-dinas",
      storageBucket: "awal-dinas.appspot.com",
      messagingSenderId: "520284327000",
      appId: "1:520284327000:web:14ce61a60480384f5a4e2d",
      measurementId: "G-GFZ4FHRHVQ"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Data laporan, awalnya kosong, nanti diisi dari Firestore
    let laporanData = [];
    let currentPage = 1;
    const rowsPerPage = 10;

    // Fungsi untuk dapatkan nama hari dalam bahasa Indonesia
    function namaHari(dateString) {
      const hariIndonesia = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
      const date = new Date(dateString);
      return hariIndonesia[date.getDay()];
    }

    // Fungsi ambil data dari Firestore
    async function ambilDataFirestore() {
      laporanData = [];
      const querySnapshot = await getDocs(collection(db, "laporanDinas"));
      querySnapshot.forEach((doc) => {
        laporanData.push({
          id: doc.id, // simpan id dokumen untuk hapus nanti
          ...doc.data()
        });
      });
      tampilkanData();
    }

    // Fungsi simpan data ke Firestore
    async function simpanKeFirestore(data) {
      try {
        const docRef = await addDoc(collection(db, "laporanDinas"), data);
        console.log("Data berhasil disimpan dengan ID:", docRef.id);
        data.id = docRef.id; // tambah id dokumen ke data lokal
        laporanData.push(data);
        tampilkanData();
      } catch (error) {
        alert("Gagal menyimpan ke Firebase: " + error.message);
      }
    }

    // Fungsi hapus data dari Firestore
    async function hapusDariFirestore(id) {
      try {
        await deleteDoc(doc(db, "laporanDinas", id));
        laporanData = laporanData.filter(item => item.id !== id);
        tampilkanData();
      } catch (error) {
        alert("Gagal menghapus data dari Firebase: " + error.message);
      }
    }

    // Form submit event
    document.getElementById('formData').addEventListener('submit', async function(e) {
      e.preventDefault();

      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const tanggal = `${yyyy}-${mm}-${dd}`;
      const hari = namaHari(tanggal);

      const data = {
        tanggal: tanggal,
        hari: hari,
        nomor_KA: document.getElementById('nomorKA').value.trim(),
        nama_masinis: document.getElementById('namaMasinis').value.trim(),
        nama_asisten: document.getElementById('namaAsisten').value.trim(),
        nomor_lokomotif: document.getElementById('nomorLokomotif').value.trim(),
        jam_datang: document.getElementById('jamDatang').value,
        terlambat_menit: parseInt(document.getElementById('terlambat').value, 10),
        tonase: parseInt(document.getElementById('tonase').value, 10),
        keterangan: document.getElementById('keterangan').value.trim()
      };

      // Simpan ke Firestore dan update tabel
      await simpanKeFirestore(data);

      this.reset();
      currentPage = Math.ceil(laporanData.length / rowsPerPage);
      tampilkanData();
    });

    // Fungsi tampilkan data di tabel dengan paging dan filter
    function tampilkanData() {
      const tbody = document.querySelector('#tabelLaporan tbody');
      tbody.innerHTML = '';

      const filterTanggal = document.getElementById('filterTanggal').value;
      const filterHari = document.getElementById('filterHari').value;

      let filteredData = laporanData;

      if (filterTanggal) filteredData = filteredData.filter(item => item.tanggal === filterTanggal);
      if (filterHari) filteredData = filteredData.filter(item => item.hari === filterHari);

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const pagedData = filteredData.slice(start, end);

      pagedData.forEach((item) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.tanggal}</td>
          <td>${item.hari}</td>
          <td>${item.nomor_KA}</td>
          <td>${item.nama_masinis}</td>
          <td>${item.nama_asisten}</td>
          <td>${item.nomor_lokomotif}</td>
          <td>${item.jam_datang}</td>
          <td>${item.terlambat_menit}</td>
          <td>${item.tonase}</td>
          <td>${item.keterangan}</td>
          <td><button class="hapus-btn" onclick="hapusData('${item.id}')">Hapus</button></td>
        `;
        tbody.appendChild(row);
      });

      buatPagination(filteredData.length);
    }

    // Fungsi buat pagination
    function buatPagination(totalData) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      const totalPages = Math.ceil(totalData / rowsPerPage);
      if (totalPages <= 1) return;

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.disabled = true;
        btn.addEventListener('click', () => {
          currentPage = i;
          tampilkanData();
        });
        pagination.appendChild(btn);
      }
    }

    // Fungsi hapus data baik lokal dan firestore
    function hapusData(id) {
      if (confirm('Yakin ingin menghapus data ini?')) {
        hapusDariFirestore(id);
      }
    }

    // Fungsi reset data: kamu bisa buat hapus semua Firestore atau hanya reset lokal
    // Karena hapus semua data Firestore butuh looping dan berhati-hati,
    // Untuk sementara ini reset hanya reset data lokal dan reload Firestore
    function resetData() {
      if (confirm('Yakin ingin menghapus semua data lokal?')) {
        laporanData = [];
        tampilkanData();
        alert("Data lokal sudah dihapus. Untuk hapus data Firestore, perlu implementasi khusus.");
      }
    }

    // Fungsi download CSV sama seperti sebelumnya
    function downloadCSV() {
      const filterTanggal = document.getElementById('filterTanggal').value;
      const filterHari = document.getElementById('filterHari').value;
      let filteredData = laporanData;
      if (filterTanggal) filteredData = filteredData.filter(item => item.tanggal === filterTanggal);
      if (filterHari) filteredData = filteredData.filter(item => item.hari === filterHari);

      const csvRows = [];
      const headers = ['Tanggal', 'Hari', 'Nomor KA', 'Nama Masinis', 'Nama Asisten', 'Nomor Lokomotif', 'Jam Datang', 'Terlambat (mnt)', 'Tonase', 'Keterangan'];
      csvRows.push(headers.join(','));

      for (const row of filteredData) {
        const values = [
          row.tanggal,
          row.hari,
          `"${row.nomor_KA}"`,
          `"${row.nama_masinis}"`,
          `"${row.nama_asisten}"`,
          `"${row.nomor_lokomotif}"`,
          row.jam_datang,
          row.terlambat_menit,
          row.tonase,
          `"${row.keterangan}"`
        ];
        csvRows.push(values.join(','));
      }

      const csvData = csvRows.join('\n');
      const blob = new Blob([csvData], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'laporan_akhir_dinas.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Fungsi cetak PDF bisa pakai library jsPDF, aku buatkan contoh minimal
    function cetakPDF() {
      alert("Fitur cetak PDF belum diimplementasikan. Bisa pakai jsPDF atau dom-to-pdf.");
    }

    // Ambil data awal saat halaman dimuat
    window.onload = ambilDataFirestore;
  </script>
</body>
</html>
